# Observability

This document describes how [OpenTelemetry](https://opentelemetry.io/docs/) (OTel) is integrated across the
three-layer architecture for distributed tracing.

We use the official [Go OTel SDK](https://pkg.go.dev/go.opentelemetry.io/otel) along with a shared helper
package from [golib](https://github.com/a-novel-kit/golib) (`github.com/a-novel-kit/golib/otel`) that wraps the
most common operations.

## Setup

OTel is initialized once in the main entrypoint. The `otel.Config` interface abstracts the trace provider, and
the preset is selected based on the environment:

```go
otel.SetAppName(cfg.App.Name)
lo.Must0(otel.Init(cfg.Otel))
defer cfg.Otel.Flush()
```

After initialization, the config also provides transport-level middleware:

- `cfg.Otel.HttpHandler()` — HTTP middleware (wraps every incoming request in a root span)
- `cfg.Otel.RpcInterceptor()` — gRPC stats handler (same purpose for gRPC servers)

## Spans

Every `Exec` or handler method creates a span. The span is started at the top of the function and deferred:

```go
ctx, span := otel.Tracer().Start(ctx, "layer.OperationName")
defer span.End()
```

The naming convention is `"[layer].[OperationName]"`:

- `"dao.CredentialsInsert"`
- `"service.CredentialsCreate"`
- `"handler.CredentialsCreate"`
- `"middlewares.Auth"`

Because each layer passes its `ctx` down, spans are automatically nested into a parent-child hierarchy:

```
OTel HTTP/gRPC middleware (root)
  └─ middlewares.Auth
       └─ handler.CredentialsCreate
            └─ service.CredentialsCreate
                 ├─ service.ShortCodeConsume
                 │    └─ dao.ShortCodeSelect
                 └─ dao.CredentialsInsert
```

Sub-operations within a single method can also create child spans:

```go
func (repository *ShortCodeInsert) discardConflicts(ctx context.Context, ...) error {
	ctx, span := otel.Tracer().Start(ctx, "dao.ShortCodeInsert(discardConflicts)")
	defer span.End()
	// ...
}
```

## Reporting

The `golib/otel` package provides three helpers for recording span outcomes.

### `otel.ReportError`

Records the error on the span and sets its status to `Error`. Returns the error for inline use:

```go
return nil, otel.ReportError(span, fmt.Errorf("execute query: %w", err))
```

### `otel.ReportSuccess`

Sets the span status to `Ok` and returns the value. Generic over any response type:

```go
return otel.ReportSuccess(span, entity), nil
```

### `otel.ReportSuccessNoContent`

Same as `ReportSuccess`, for methods that return only an error:

```go
otel.ReportSuccessNoContent(span)
return nil
```

Every code path in a method should end with one of these three calls, so that every span has a definitive
status.

## Span attributes

Use `span.SetAttributes` to attach structured data to a span. Attributes can be added progressively as
the method executes:

```go
span.SetAttributes(attribute.String("credentials.id", request.ID.String()))
span.SetAttributes(attribute.String("credentials.email", request.Email))
span.SetAttributes(attribute.Bool("exists", exists))
```

**Sensitive fields must be masked.** Never log passwords, tokens, or short codes in plaintext:

```go
span.SetAttributes(attribute.String("password", strings.Repeat("*", len(request.Password))))
span.SetAttributes(attribute.String("shortCode", strings.Repeat("*", len(request.ShortCode))))
```
