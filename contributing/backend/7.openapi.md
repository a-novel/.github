# OpenAPI

HTTP services should provide an [OpenAPI 3.x](https://spec.openapis.org/oas/v3.1.1.html) specification
describing their public API. The spec is a YAML file at the root of the repository:

```txt
- openapi.yaml
- openapi.html
```

> gRPC services do not need an OpenAPI spec — their API is defined by proto files
> (see [layers documentation](./2.layers.md#proto-schemas)).

## Writing the spec

The spec can be written by hand, with a visual editor, or generated with AI from the handler code.

We recommend using the [Swagger Editor](https://editor.swagger.io/) for manual editing: it provides
live validation and a preview of the rendered documentation.

When using AI, feed it the handler files (request/response DTOs, error mappings, route definitions) and ask
it to produce a spec that matches. **Always request at least one self-review pass**: ask the AI to re-read
its output and check for inconsistencies (wrong status codes, missing fields, mismatched types). Repeat as long
as errors are found.

## Structure

The spec should follow standard OpenAPI conventions:

- `info` — service name, version, description
- `paths` — one entry per route, with `operationId`, `summary`, `description`, `tags`, `security`, `responses`
- `components/schemas` — shared request/response schemas
- `components/responses` — reusable response definitions
- `components/securitySchemes` — authentication methods (e.g., `BearerAuth`)

```yaml
# Created with https://editor.swagger.io/
openapi: 3.1.0

info:
  title: Authentication API
  version: v2.3.0

paths:
  /credentials:
    post:
      operationId: credentialsCreate
      summary: Register a new user.
      tags: [credentials]
      security:
        - BearerAuth: []
      requestBody:
        $ref: "#/components/requestBodies/credentialsCreate"
      responses:
        "200":
          $ref: "#/components/responses/token"
        "409":
          $ref: "#/components/responses/conflict"
        "422":
          $ref: "#/components/responses/validationError"
```

The error responses in the spec must match the `httpf.ErrMap` defined in each handler
(see [error handling documentation](./4.errors.md#http--httpferrmap)).

## Publishing

When available, the OpenAPI documentation is automatically published to GitHub Pages on every push to `master`.
The CI pipeline copies `openapi.yaml` and `openapi.html` into a Pages artifact:

```yaml
publish-docs:
  steps:
    - run: |
        mkdir _site
        mv openapi.html _site/index.html
        mv openapi.yaml _site/openapi.yaml
    - uses: actions/configure-pages@v5
    - uses: actions/upload-pages-artifact@v4
    - uses: actions/deploy-pages@v4
```

The `openapi.html` file is a pre-built static page (using [Redoc](https://github.com/Redocly/redoc) or
similar) that renders the spec. It should be regenerated whenever the YAML changes.
